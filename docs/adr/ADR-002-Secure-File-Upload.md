# ADR-002: Secure File Upload for User Avatars

**Дата**: 2025-10-22
**Статус**: Accepted

## Context
Habit Tracker планирует добавить загрузку аватаров пользователей. Безопасность загрузки критично, чтобы предотвратить path traversal, загрузку вредоносных файлов или DoS (риски R2, R3, P04). Альтернативы:
- Pillow для проверки изображений (тяжёлый, требует зависимостей).
- Magic bytes + UUID (лёгкий, без внешних библиотек).
- Хранить в S3 (сложно для SQLite-based проекта).

## Decision
Реализовать проверку загрузки в `src/app/upload.py`:
- Проверять magic bytes (PNG/JPEG).
- Лимит размера: 5 MB.
- Имя файла: UUID + расширение (.png/.jpg).
- Канонизация пути с `Path.resolve()`.
- Запрет симлинков.
Ошибки возвращать в формате RFC 7807 (ADR-001).

## Consequences
**Плюсы**:
- Закрывает риски R2 (утечка PII), R3 (DoS) из P04.
- Лёгкая реализация без внешних библиотек.
- Совместимо с SQLite-based проектом.
**Минусы**:
- Ограничение на PNG/JPEG (нет поддержки других форматов).
- Дополнительные тесты для негативных сценариев.
**Trade-offs**: Простота против универсальности (поддержка только PNG/JPEG).

## Links
- NFR-03 (Validation, P03)
- R2 (Утечка PII), R3 (DoS) (P04)
- F3 (API → DB, P04)
- tests/test_upload.py::test_rejects_big_file
